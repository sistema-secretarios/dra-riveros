<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Causas</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* --- ESTILOS GENERALES (Sin cambios) --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .toolbar {
            display: flex;
            align-items: center;
            flex-grow: 1;
            gap: 15px;
        }

        #filtroBusqueda {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 250px;
        }

        #btnNuevoRegistro, #btnImprimirListado {
            padding: 10px 15px;
            background-color: #2e7d32;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
        }

        #btnNuevoRegistro:hover, #btnImprimirListado:hover {
            background-color: #1b5e20;
        }

        .table-responsive {
            overflow-x: auto;
            margin-top: 20px;
        }

        #tablaCausas {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        #tablaCausas th, #tablaCausas td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        #tablaCausas th {
            background-color: #2e7d32;
            color: white;
        }

        #tablaCausas tr:hover {
            background-color: #f5f5f5;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .action-buttons button {
            padding: 6px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
            font-size: 12px;
        }

        .btn-ver { background-color: #388e3c; }
        .btn-editar { background-color: #43a047; }
        .btn-eliminar { background-color: #c62828; }

        .pagination-controls {
            display: flex;
            align-items: center;
            user-select: none;
            gap: 5px;
        }

        .pagination-controls.centered {
            justify-content: center;
            margin: 15px 0;
        }

        .pagination-controls button {
            padding: 8px 12px;
            border: 1px solid #2e7d32;
            background-color: #fff;
            color: #2e7d32;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .pagination-controls button.active {
            background-color: #2e7d32;
            color: white;
        }

        .pagination-controls button:disabled {
            border: 1px solid #ccc;
            color: #ccc;
            cursor: not-allowed;
        }
        
        .pagination-controls span {
            margin: 0 10px;
            font-weight: bold;
            white-space: nowrap;
        }
        
        #alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
        }

        .toast-alert {
            min-width: 280px;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateY(100%);
        }

        .toast-alert.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-success {
            background-color: #2e7d32;
        }

        .toast-error {
            background-color: #c62828;
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0, 0, 0, 0.6); 
        }
        
        .modal-content { 
            background-color: #fff; 
            margin: 5% auto; 
            padding: 20px; 
            border: 1px solid #888; 
            border-radius: 8px; 
            position: relative; 
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19); 
            animation-name: animatetop; 
            animation-duration: 0.4s; 
        }
        
        .medium-modal { width: 80%; max-width: 800px; }
        .small-modal { width: 60%; max-width: 600px; }
        
        @keyframes animatetop { 
            from {top: -300px; opacity: 0} 
            to {top: 0; opacity: 1} 
        }
        
        .close-btn { 
            color: #aaa; 
            float: right; 
            font-size: 28px; 
            font-weight: bold; 
            text-decoration: none; 
            cursor: pointer;
        }
        
        .close-btn:hover {
            color: #000;
        }
        
        .tabs {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            font-weight: bold;
        }
        
        .tab.active {
            background-color: #2e7d32;
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 15px;
            border: 1px solid #ddd;
            border-top: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input, 
        .form-group textarea,
        .form-group select { /* MEJORA: Estilo unificado para selects */
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .seguimiento-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .seguimiento-table th, 
        .seguimiento-table td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
            vertical-align: middle; /* MEJORA: Alineación vertical */
        }
        
        .seguimiento-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        .seguimiento-table input,
        .seguimiento-table select { /* MEJORA: Estilo unificado para selects */
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        
        .btn-agregar-fila {
            background-color: #2e7d32;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .btn-eliminar-fila {
            background-color: #c62828;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .date-input-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .date-input-container input[type="date"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        #btnGuardar { 
            background-color: #2e7d32; 
            color: white; 
            padding: 10px 15px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 16px; 
            width: 100%; 
            margin-top: 15px; 
        }

        #btnGuardar:hover {
            background-color: #1b5e20;
        }
        
        /* MEJORA: Estilo para botón deshabilitado */
        #btnGuardar:disabled {
            background-color: #9e9e9e;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        /* MEJORA: Estilos de Impresión */
        @media print {
            body {
                background-color: #fff;
                padding: 0;
            }
            .container {
                box-shadow: none;
                border: none;
                width: 100%;
                max-width: 100%;
                padding: 0;
            }
            .header-container, .modal, .action-buttons, .pagination-controls, #alert-container {
                display: none !important;
            }
            #tablaCausas th, #tablaCausas td {
                border: 1px solid #000;
                padding: 8px;
                font-size: 10pt;
            }
            #tablaCausas th {
                background-color: #eee !important;
                color: #000 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            #tablaCausas {
                width: 100%;
                border-collapse: collapse;
            }
            @page {
                size: A4 landscape;
                margin: 2cm;
            }
        }

        @media (max-width: 850px) {
            .header-container {
                flex-direction: column;
                align-items: flex-start;
            }
            .toolbar {
                flex-direction: column;
                align-items: stretch;
                width: 100%;
                gap: 10px;
            }
            #filtroBusqueda {
                width: 100%;
            }
            .pagination-controls {
                justify-content: space-between;
                width: 100%;
            }
            .pagination-controls.centered {
                justify-content: center;
            }
            .modal-content {
                margin: 5% auto;
                width: 95% !important;
            }
            .action-buttons {
                flex-direction: column;
            }
            .tabs {
                flex-direction: column;
            }
            .tab {
                margin-bottom: 5px;
                border-radius: 5px;
            }
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            .seguimiento-table {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <div class="toolbar">
                <input type="text" id="filtroBusqueda" placeholder="Buscar por número, carátula, observaciones..." title="Filtro de búsqueda">
                <div id="topPagination" class="pagination-controls"></div>
                <button id="btnNuevoRegistro" title="Abrir modal de Nuevo Registro">➕ Nuevo Registro</button>
                <button id="btnImprimirListado" title="Imprimir listado completo">🖨️ Imprimir Listado</button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table id="tablaCausas">
                <thead>
                    <tr>
                        <th>Número y Carátula</th>
                        <th>Tipo de Proceso</th>
                        <th>Juzgado</th>
                        <th>Empleado</th>
                        <th>Audiencias y Vencimientos</th>
                        <th>Observaciones</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        
        <div id="bottomPagination" class="pagination-controls centered"></div>
    </div>
    
    <div id="alert-container"></div>

    <div id="modalRegistro" class="modal">
        <div class="modal-content medium-modal">
            <a href="#" class="close-btn">&times;</a>
            <h2><span id="modalTitle">Nuevo</span> Registro de Causa</h2>
            
            <div class="tabs">
                <div class="tab active" data-tab="datos-expediente">Datos del Expediente</div>
                <div class="tab" data-tab="documental">Documental</div>
                <div class="tab" data-tab="firma-digital">Firma Digital</div>
                <div class="tab" data-tab="situacion-procesal">Situación Procesal</div>
                <div class="tab" data-tab="audiencias-vencimientos">Audiencias y Vencimientos</div>
                <div class="tab" data-tab="observaciones">Observaciones</div>
            </div>
            
            <form id="formRegistro">
                <div class="tab-content active" id="datos-expediente">
                    <div class="form-group">
                        <label for="numeroCaratula">Número y Carátula:</label>
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <input type="text" id="numeroCaratula" list="causasList" placeholder="Buscar o escribir nuevo expediente..." required>
                                <datalist id="causasList">
                                    </datalist>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <button type="button" id="btnNuevoExpediente" class="btn-agregar-fila">➕ Nuevo Expediente</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tipoProceso">Tipo de Proceso:</label>
                            <input type="text" id="tipoProceso" placeholder="Ej: Civil, Penal, Laboral...">
                        </div>
                        <div class="form-group">
                            <label for="juzgado">Juzgado:</label>
                            <input type="text" id="juzgado" placeholder="Ej: Juzgado Civil y Comercial N°1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="empleado">Empleado Asignado:</label>
                        <input type="text" id="empleado" placeholder="Ej: Juan Pérez">
                    </div>
                </div>
                
                <div class="tab-content" id="documental">
                    <div class="form-group">
                        <label for="documentosPresentados">Documentos Presentados:</label>
                        <textarea id="documentosPresentados" rows="4" placeholder="Lista de documentos presentados"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="estadoDocumental">Estado Documental:</label>
                        <input type="text" id="estadoDocumental" placeholder="Ej: Completo, Incompleto, Pendiente...">
                    </div>
                </div>
                
                <div class="tab-content" id="firma-digital">
                    <div class="form-group">
                        <table class="seguimiento-table" id="tablaFirmaDigital">
                            <thead>
                                <tr>
                                    <th>Pieza Procesal</th>
                                    <th>Fecha Firma</th>
                                    <th>Firma de</th>
                                    <th>Tipo Defensor</th>
                                    <th>Detalle Subrogante</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                        <button type="button" class="btn-agregar-fila" id="btnAgregarFirma">+ Agregar Firma</button>
                    </div>
                </div>
                
                <div class="tab-content" id="situacion-procesal">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modoIntervencion">Modo de Intervención:</label>
                            <input type="text" id="modoIntervencion" placeholder="Ej: Demanda, Contestación, Apelación...">
                        </div>
                        <div class="form-group">
                            <label for="prioridadTarea">Prioridad de Tarea:</label>
                            <input type="text" id="prioridadTarea" placeholder="Ej: Alta, Media, Baja, Urgente">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="estadoProcesal">Estado Procesal:</label>
                            <input type="text" id="estadoProcesal" placeholder="Ej: Iniciado, En Trámite, Sentencia...">
                        </div>
                        <div class="form-group">
                            <label for="fechaEstado">Fecha del Estado:</label>
                            <div class="date-input-container">
                                <input type="date" id="fechaEstado">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Seguimiento:</label>
                        <table class="seguimiento-table" id="tablaSeguimiento">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Detalles</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                        <button type="button" class="btn-agregar-fila" id="btnAgregarSeguimiento">+ Agregar Seguimiento</button>
                    </div>
                </div>
                
                <div class="tab-content" id="audiencias-vencimientos">
                    <div class="form-group">
                        <h3>Audiencias</h3>
                        <table class="seguimiento-table" id="tablaAudiencias">
                            <thead>
                                <tr>
                                    <th>Fecha y Hora</th>
                                    <th>Detalle</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                        <button type="button" class="btn-agregar-fila" id="btnAgregarAudiencia">+ Agregar Audiencia</button>
                    </div>
                    
                    <div class="form-group">
                        <h3>Vencimientos</h3>
                        <table class="seguimiento-table" id="tablaVencimientos">
                            <thead>
                                <tr>
                                    <th>Fecha y Hora</th>
                                    <th>Detalle</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                        <button type="button" class="btn-agregar-fila" id="btnAgregarVencimiento">+ Agregar Vencimiento</button>
                    </div>
                    
                    <div class="form-group">
                        <h3>Otras Actividades</h3>
                        <table class="seguimiento-table" id="tablaActividades">
                            <thead>
                                <tr>
                                    <th>Fecha y Hora</th>
                                    <th>Detalle</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                        <button type="button" class="btn-agregar-fila" id="btnAgregarActividad">+ Agregar Actividad</button>
                    </div>
                </div>
                
                <div class="tab-content" id="observaciones">
                    <div class="form-group">
                        <label for="observacionesGenerales">Observaciones Generales:</label>
                        <textarea id="observacionesGenerales" rows="6" placeholder="Observaciones adicionales sobre la causa"></textarea>
                    </div>
                </div>
                
                <button type="submit" id="btnGuardar">Guardar</button>
            </form>
        </div>
    </div>

    <div id="modalVer" class="modal">
        <div class="modal-content small-modal">
            <a href="#" class="close-btn">&times;</a>
            <h2>Detalle de la Causa</h2>
            <div id="detalleContenido">
                </div>
        </div>
    </div>

    <script>
        // --- ADVERTENCIA DE SEGURIDAD ---
        // Las claves de API y la configuración de Firebase no deben estar expuestas en el código del lado del cliente.
        // Un atacante podría usarlas para abusar de tu proyecto de Firebase.
        // Considera usar variables de entorno y un backend, o las Reglas de Seguridad de Firebase y App Check para proteger tu aplicación.

        // --- CONFIGURACIÓN FIREBASE ---
        const firebaseConfigOriginal = {
            apiKey: "AIzaSyBt6X0u0BpiNPcV2SNPrN-spCmjl2AhZaA",
            authDomain: "causas-defensoria.firebaseapp.com",
            databaseURL: "https://causas-defensoria-default-rtdb.firebaseio.com",
            projectId: "causas-defensoria",
            storageBucket: "causas-defensoria.firebasestorage.app",
            messagingSenderId: "186064671470",
            appId: "1:186064671470:web:b58bae5eadbe6e469f19ff"
        };

        const firebaseConfigNueva = {
            apiKey: "AIzaSyDJZiGAhByx5zCIVg79fIMlzE1njuauW3k",
            authDomain: "secretarios-def.firebaseapp.com",
            projectId: "secretarios-def",
            storageBucket: "secretarios-def.firebasestorage.app",
            messagingSenderId: "533584198983",
            appId: "1:533584198983:web:f51f57146ed16c813ca062"
        };

        // Inicializar Firebase para la base original (solo lectura para autocompletar)
        const appOriginal = firebase.initializeApp(firebaseConfigOriginal, "original");
        const dbOriginal = firebase.firestore(appOriginal);

        // Inicializar Firebase para la nueva base (lectura/escritura)
        const appNueva = firebase.initializeApp(firebaseConfigNueva, "nueva");
        const dbNueva = firebase.firestore(appNueva);

        // --- CONFIGURACIÓN Y DATOS PARA PRODUCCIÓN ---
        
        const RECORDS_PER_PAGE = 10;
        let currentPage = 1;
        let causas = [];
        let filteredCausas = [];
        let editingId = null;
        let causasData = [];
        
        // --- ELEMENTOS DEL DOM ---
        const tablaBody = document.querySelector('#tablaCausas tbody');
        const filtroBusqueda = document.getElementById('filtroBusqueda');
        const modalRegistro = document.getElementById('modalRegistro');
        const btnNuevoRegistro = document.getElementById('btnNuevoRegistro');
        const btnImprimirListado = document.getElementById('btnImprimirListado');
        const btnGuardar = document.getElementById('btnGuardar');
        const modalVer = document.getElementById('modalVer');
        const formRegistro = document.getElementById('formRegistro');
        const modalTitle = document.getElementById('modalTitle');
        const detalleContenido = document.getElementById('detalleContenido');
        const topPagination = document.getElementById('topPagination');
        const bottomPagination = document.getElementById('bottomPagination');
        const alertContainer = document.getElementById('alert-container');
        const tablaSeguimiento = document.getElementById('tablaSeguimiento');
        const btnAgregarSeguimiento = document.getElementById('btnAgregarSeguimiento');
        const tablaAudiencias = document.getElementById('tablaAudiencias');
        const btnAgregarAudiencia = document.getElementById('btnAgregarAudiencia');
        const tablaVencimientos = document.getElementById('tablaVencimientos');
        const btnAgregarVencimiento = document.getElementById('btnAgregarVencimiento');
        const tablaActividades = document.getElementById('tablaActividades');
        const btnAgregarActividad = document.getElementById('btnAgregarActividad');
        const tablaFirmaDigital = document.getElementById('tablaFirmaDigital');
        const btnAgregarFirma = document.getElementById('btnAgregarFirma');
        const btnNuevoExpediente = document.getElementById('btnNuevoExpediente');

        // --- UTILIDADES ---

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const parts = dateString.split('-');
            if (parts.length === 3) {
                const [year, month, day] = parts;
                return `${day}/${month}/${year}`;
            }
            return dateString;
        }

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return 'N/A';
            try {
                const date = new Date(dateTimeString);
                if (isNaN(date)) return dateTimeString; // MEJORA: Validar fecha inválida
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            } catch (e) {
                return dateTimeString;
            }
        }

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast-alert toast-${type}`;
            toast.textContent = message;
            
            alertContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10); 

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 4000); 
        }

        function showLoading() {
            tablaBody.innerHTML = `
                <tr>
                    <td colspan="7" class="loading">
                        Cargando datos...
                    </td>
                </tr>
            `;
        }

        // --- FUNCIONES DE AUTORRELLENADO ---

        async function cargarDatosCausas() {
            try {
                const causasSnapshot = await dbOriginal.collection('causas').get();
                const causasList = document.getElementById('causasList');
                causasList.innerHTML = '';
                
                causasData = causasSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                causasData.forEach(causa => {
                    const option = document.createElement('option');
                    option.value = `${causa.numCausa} - ${causa.caratula || ''}`;
                    causasList.appendChild(option);
                });

            } catch (error) {
                console.error('Error cargando datos de causas para autocompletar:', error);
                showToast('Error al cargar la lista de expedientes', 'error');
            }
        }

        document.getElementById('numeroCaratula').addEventListener('change', function() {
            const valorSeleccionado = this.value;
            const causaEncontrada = causasData.find(c => 
                valorSeleccionado === `${c.numCausa} - ${c.caratula || ''}` || 
                valorSeleccionado === c.numCausa
            );
            
            if (causaEncontrada) {
                this.value = `${causaEncontrada.numCausa} - ${causaEncontrada.caratula || ''}`;
                document.getElementById('tipoProceso').value = causaEncontrada.tipoProceso || '';
                document.getElementById('juzgado').value = causaEncontrada.juzgado || '';
                document.getElementById('empleado').value = causaEncontrada.usuarioAsignado || '';
                document.getElementById('modoIntervencion').value = causaEncontrada.intervencion || '';
            }
        });

        btnNuevoExpediente.addEventListener('click', () => {
            document.getElementById('numeroCaratula').value = '';
            document.getElementById('numeroCaratula').focus();
        });

        // --- FUNCIONES DE RENDERING Y LÓGICA DE DATOS ---

        function renderTable(data) {
            filteredCausas = data;
            const totalPages = Math.ceil(filteredCausas.length / RECORDS_PER_PAGE);
            
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;

            const start = (currentPage - 1) * RECORDS_PER_PAGE;
            const end = start + RECORDS_PER_PAGE;
            const paginatedData = filteredCausas.slice(start, end);
            
            tablaBody.innerHTML = '';
            
            if (paginatedData.length === 0) {
                const row = tablaBody.insertRow();
                row.innerHTML = `<td colspan="7" style="text-align: center; padding: 30px; color: #666;">No hay causas para mostrar.</td>`;
                renderPaginationSelectors(0); // MEJORA: Limpiar paginación si no hay datos
                return;
            }

            paginatedData.forEach(causa => {
                const row = tablaBody.insertRow();
                let audienciasVencimientosText = '';
                
                if (causa.audiencias && causa.audiencias.length > 0) audienciasVencimientosText += `Audiencias: ${causa.audiencias.length}<br>`;
                if (causa.vencimientos && causa.vencimientos.length > 0) audienciasVencimientosText += `Vencimientos: ${causa.vencimientos.length}<br>`;
                if (causa.actividades && causa.actividades.length > 0) audienciasVencimientosText += `Actividades: ${causa.actividades.length}`;
                
                // CORRECCIÓN/MEJORA: Uso de `observacionesGenerales` y truncado para mejor visualización
                const obsText = causa.observacionesGenerales || '';
                const shortObs = obsText.length > 50 ? obsText.substring(0, 50) + '...' : obsText;
                
                row.innerHTML = `
                    <td><strong>${causa.numeroCaratula || 'N/A'}</strong></td>
                    <td>${causa.tipoProceso || 'N/A'}</td>
                    <td>${causa.juzgado || 'N/A'}</td>
                    <td>${causa.empleado || 'N/A'}</td>
                    <td>${audienciasVencimientosText || 'N/A'}</td>
                    <td title="${obsText}">${shortObs || 'N/A'}</td>
                    <td class="action-buttons">
                        <button class="btn-ver" data-id="${causa.id}" title="Ver detalles completos">👁️ Ver</button>
                        <button class="btn-editar" data-id="${causa.id}" title="Editar registro">✏️ Editar</button>
                        <button class="btn-eliminar" data-id="${causa.id}" data-caratula="${causa.numeroCaratula}" title="Eliminar registro">🗑️ Eliminar</button>
                    </td>
                `;
            });
            
            renderPaginationSelectors(totalPages);
        }
        
        // MEJORA: Delegación de eventos para los botones de acción en la tabla
        tablaBody.addEventListener('click', (event) => {
            const target = event.target.closest('button');
            if (!target) return;

            const id = target.dataset.id;
            if (target.classList.contains('btn-ver')) {
                verRegistro(id);
            } else if (target.classList.contains('btn-editar')) {
                abrirModalRegistro(id);
            } else if (target.classList.contains('btn-eliminar')) {
                const caratula = target.dataset.caratula;
                confirmAndDelete(id, caratula);
            }
        });

        // --- PAGINACIÓN ---
        function changePage(page) {
            const totalPages = Math.ceil(filteredCausas.length / RECORDS_PER_PAGE);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderTable(filteredCausas);
        }

        function renderPaginationSelectors(totalPages) {
            if (totalPages <= 1) {
                topPagination.innerHTML = '';
                bottomPagination.innerHTML = '';
                return;
            }

            const disabledPrev = currentPage === 1 ? 'disabled' : '';
            const disabledNext = currentPage === totalPages ? 'disabled' : '';

            let pagesHtml = '';
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            if (currentPage <= 3) endPage = Math.min(totalPages, 5);
            if (currentPage > totalPages - 2) startPage = Math.max(1, totalPages - 4);
            
            for (let i = startPage; i <= endPage; i++) {
                pagesHtml += `<button data-page="${i}" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
            }

            const paginationHTML = `
                <button data-page="${currentPage - 1}" ${disabledPrev}>« Anterior</button>
                <span>Página ${currentPage} de ${totalPages}</span>
                ${pagesHtml}
                <button data-page="${currentPage + 1}" ${disabledNext}>Siguiente »</button>
            `;
            
            topPagination.innerHTML = paginationHTML;
            bottomPagination.innerHTML = paginationHTML;
        }

        function handlePaginationClick(event) {
            const target = event.target.closest('button');
            if (target && target.dataset.page) {
                changePage(parseInt(target.dataset.page, 10));
            }
        }
        topPagination.addEventListener('click', handlePaginationClick);
        bottomPagination.addEventListener('click', handlePaginationClick);

        // --- GESTIÓN DE PESTAÑAS ---
        function initTabs() {
            const tabsContainer = document.querySelector('.tabs');
            tabsContainer.addEventListener('click', (event) => {
                const tab = event.target.closest('.tab');
                if (!tab) return;
                
                tabsContainer.querySelector('.active').classList.remove('active');
                tab.classList.add('active');
                
                const tabId = tab.dataset.tab;
                document.querySelector('.tab-content.active').classList.remove('active');
                document.getElementById(tabId).classList.add('active');
            });
        }
        
        // --- GESTIÓN DE TABLAS DINÁMICAS (Seguimiento, Firma, etc.) ---

        function setupDynamicTable(tableId, addButtonId, addRowFunction) {
            const table = document.getElementById(tableId);
            const addButton = document.getElementById(addButtonId);
            
            table.querySelector('tbody').addEventListener('click', (event) => {
                const btn = event.target.closest('.btn-eliminar-fila');
                if (btn) {
                    btn.closest('tr').remove();
                }
            });
            
            addButton.addEventListener('click', () => addRowFunction());
        }

        function agregarFilaGenerica(tbody, rowHTML) {
            const row = tbody.insertRow();
            row.innerHTML = rowHTML;
        }

        function agregarFilaSeguimiento(fecha = '', detalles = '') {
            const tbody = tablaSeguimiento.querySelector('tbody');
            agregarFilaGenerica(tbody, `
                <td><input type="date" value="${fecha}"></td>
                <td><input type="text" placeholder="Detalles del seguimiento" value="${detalles}"></td>
                <td><button type="button" class="btn-eliminar-fila">Eliminar</button></td>
            `);
        }

        function agregarFilaFechaHora(tabla, fechaHora = '', detalle = '') {
            const tbody = tabla.querySelector('tbody');
            agregarFilaGenerica(tbody, `
                <td><input type="datetime-local" value="${fechaHora}"></td>
                <td><input type="text" placeholder="Detalle" value="${detalle}"></td>
                <td><button type="button" class="btn-eliminar-fila">Eliminar</button></td>
            `);
        }

        function agregarFilaFirmaDigital(item = {}) {
            const tbody = tablaFirmaDigital.querySelector('tbody');
            const row = tbody.insertRow();
            
            row.innerHTML = `
                <td><input type="text" placeholder="Pieza procesal" value="${item.piezaProcesal || ''}"></td>
                <td><input type="date" value="${item.fechaFirma || ''}"></td>
                <td>
                    <select class="firma-de-select">
                        <option value="">Seleccionar</option>
                        <option value="Secretario" ${item.firmaDe === 'Secretario' ? 'selected' : ''}>Secretario</option>
                        <option value="Defensor" ${item.firmaDe === 'Defensor' ? 'selected' : ''}>Defensor</option>
                    </select>
                </td>
                <td>
                    <select class="tipo-defensor-select" ${item.firmaDe !== 'Defensor' ? 'disabled' : ''}>
                        <option value="">Seleccionar</option>
                        <option value="Titular" ${item.tipoDefensor === 'Titular' ? 'selected' : ''}>Titular</option>
                        <option value="Subrogante" ${item.tipoDefensor === 'Subrogante' ? 'selected' : ''}>Subrogante</option>
                    </select>
                </td>
                <td><input type="text" class="detalle-subrogante-input" placeholder="Detalle subrogante" value="${item.detalleSubrogante || ''}" ${item.tipoDefensor !== 'Subrogante' ? 'disabled' : ''}></td>
                <td><button type="button" class="btn-eliminar-fila">Eliminar</button></td>
            `;

            row.querySelector('.firma-de-select').addEventListener('change', function() {
                const tipoDefensorSelect = row.querySelector('.tipo-defensor-select');
                const esDefensor = this.value === 'Defensor';
                tipoDefensorSelect.disabled = !esDefensor;
                if (!esDefensor) {
                    tipoDefensorSelect.value = '';
                    tipoDefensorSelect.dispatchEvent(new Event('change'));
                }
            });

            row.querySelector('.tipo-defensor-select').addEventListener('change', function() {
                const detalleSubroganteInput = row.querySelector('.detalle-subrogante-input');
                const esSubrogante = this.value === 'Subrogante';
                detalleSubroganteInput.disabled = !esSubrogante;
                if (!esSubrogante) {
                    detalleSubroganteInput.value = '';
                }
            });
        }
        
        function obtenerDatosTabla(tbodySelector, fields) {
            const tbody = document.querySelector(tbodySelector);
            return Array.from(tbody.querySelectorAll('tr')).map(row => {
                const item = {};
                row.querySelectorAll('input, select').forEach((input, index) => {
                    if(fields[index]) item[fields[index]] = input.value;
                });
                return item;
            }).filter(item => Object.values(item).some(val => val));
        }

        // --- FUNCIONES DE FIREBASE ---

        async function cargarCausasDesdeFirebase() {
            try {
                showLoading();
                const querySnapshot = await dbNueva.collection('miscausas').get();
                causas = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                localStorage.setItem('causas', JSON.stringify(causas));
                renderTable(causas);
                showToast(`Se cargaron ${causas.length} registros desde Firebase.`, 'success');
            } catch (error) {
                console.error('Error cargando datos desde Firebase:', error);
                showToast('Error al cargar datos. Intentando cargar desde respaldo local.', 'error');
                const storedCausas = localStorage.getItem('causas');
                if (storedCausas) {
                    causas = JSON.parse(storedCausas);
                    renderTable(causas);
                    showToast('Datos cargados desde respaldo local.', 'success');
                }
            }
        }

        async function guardarCausaEnFirebase(causa) {
            try {
                if (editingId) {
                    await dbNueva.collection('miscausas').doc(editingId).update(causa);
                    showToast('Registro actualizado correctamente.', 'success');
                } else {
                    const docRef = await dbNueva.collection('miscausas').add(causa);
                    causa.id = docRef.id; // Asignar el nuevo ID para la actualización local
                    showToast('Registro guardado correctamente.', 'success');
                }
                return causa;
            } catch (error) {
                console.error('Error guardando en Firebase:', error);
                showToast('Error al guardar en Firebase. Verifique la conexión.', 'error');
                return null;
            }
        }

        async function eliminarCausaDeFirebase(id) {
            try {
                await dbNueva.collection('miscausas').doc(id).delete();
                showToast('Registro eliminado correctamente.', 'success');
                return true;
            } catch (error) {
                console.error('Error eliminando de Firebase:', error);
                showToast('Error al eliminar. Verifique la conexión.', 'error');
                return false;
            }
        }

        // --- GESTIÓN DE MODALES ---

        function abrirModalRegistro(id = null) {
            formRegistro.reset();
            editingId = id;

            // Limpiar y preparar tablas dinámicas
            ['#tablaSeguimiento tbody', '#tablaAudiencias tbody', '#tablaVencimientos tbody', '#tablaActividades tbody', '#tablaFirmaDigital tbody'].forEach(sel => document.querySelector(sel).innerHTML = '');

            if (id) {
                modalTitle.textContent = 'Editar';
                const causa = causas.find(c => c.id === id);
                if (causa) {
                    document.getElementById('numeroCaratula').value = causa.numeroCaratula || '';
                    document.getElementById('tipoProceso').value = causa.tipoProceso || '';
                    document.getElementById('juzgado').value = causa.juzgado || '';
                    document.getElementById('empleado').value = causa.empleado || '';
                    document.getElementById('documentosPresentados').value = causa.documentosPresentados || '';
                    document.getElementById('estadoDocumental').value = causa.estadoDocumental || '';
                    document.getElementById('modoIntervencion').value = causa.modoIntervencion || '';
                    document.getElementById('prioridadTarea').value = causa.prioridadTarea || '';
                    document.getElementById('estadoProcesal').value = causa.estadoProcesal || '';
                    document.getElementById('fechaEstado').value = causa.fechaEstado || '';
                    // CORRECCIÓN: Cargar observaciones en el textarea correcto
                    document.getElementById('observacionesGenerales').value = causa.observacionesGenerales || '';
                    
                    (causa.seguimiento || []).forEach(item => agregarFilaSeguimiento(item.fecha, item.detalles));
                    (causa.audiencias || []).forEach(item => agregarFilaFechaHora(tablaAudiencias, item.fechaHora, item.detalle));
                    (causa.vencimientos || []).forEach(item => agregarFilaFechaHora(tablaVencimientos, item.fechaHora, item.detalle));
                    (causa.actividades || []).forEach(item => agregarFilaFechaHora(tablaActividades, item.fechaHora, item.detalle));
                    (causa.firmaDigital || []).forEach(item => agregarFilaFirmaDigital(item));
                }
            } else {
                modalTitle.textContent = 'Nuevo';
                // Añadir una fila vacía por defecto para una mejor UX
                agregarFilaSeguimiento();
                agregarFilaFechaHora(tablaAudiencias);
                agregarFilaFechaHora(tablaVencimientos);
                agregarFilaFechaHora(tablaActividades);
                agregarFilaFirmaDigital();
            }
            
            // Resetear pestañas
            document.querySelector('.tab.active').classList.remove('active');
            document.querySelector('.tab-content.active').classList.remove('active');
            document.querySelector('.tab[data-tab="datos-expediente"]').classList.add('active');
            document.getElementById('datos-expediente').classList.add('active');
            
            modalRegistro.style.display = 'block';
        }

        function verRegistro(id) {
            const causa = causas.find(c => c.id === id);
            if (!causa) return;

            // MEJORA: Función para generar tablas de detalles de forma limpia
            const createDetailTable = (title, headers, data, formatters) => {
                if (!data || data.length === 0) return '';
                let tableHTML = `
                    <div class="form-group">
                        <label><strong>${title}:</strong></label>
                        <table class="seguimiento-table">
                            <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                            <tbody>
                `;
                data.forEach(item => {
                    tableHTML += `<tr>${Object.keys(item).map((key, i) => `<td>${formatters[i](item[key]) || 'N/A'}</td>`).join('')}</tr>`;
                });
                tableHTML += `</tbody></table></div>`;
                return tableHTML;
            };

            let contenidoHTML = `
                <div class="form-group"><label><strong>Número y Carátula:</strong></label><p>${causa.numeroCaratula || 'N/A'}</p></div>
                <div class="form-row">
                    <div class="form-group"><label><strong>Tipo de Proceso:</strong></label><p>${causa.tipoProceso || 'N/A'}</p></div>
                    <div class="form-group"><label><strong>Juzgado:</strong></label><p>${causa.juzgado || 'N/A'}</p></div>
                </div>
                <div class="form-group"><label><strong>Empleado Asignado:</strong></label><p>${causa.empleado || 'N/A'}</p></div>
                <div class="form-group"><label><strong>Documentos Presentados:</strong></label><p>${causa.documentosPresentados || 'N/A'}</p></div>
                <div class="form-group"><label><strong>Estado Documental:</strong></label><p>${causa.estadoDocumental || 'N/A'}</p></div>
            `;
            
            contenidoHTML += createDetailTable('Firma Digital', ['Pieza Procesal', 'Fecha', 'Firma de', 'Tipo', 'Detalle'], causa.firmaDigital, [v => v, formatDate, v => v, v => v, v => v]);
            contenidoHTML += createDetailTable('Seguimiento', ['Fecha', 'Detalles'], causa.seguimiento, [formatDate, v => v]);
            contenidoHTML += createDetailTable('Audiencias', ['Fecha y Hora', 'Detalle'], causa.audiencias, [formatDateTime, v => v]);
            contenidoHTML += createDetailTable('Vencimientos', ['Fecha y Hora', 'Detalle'], causa.vencimientos, [formatDateTime, v => v]);
            contenidoHTML += createDetailTable('Otras Actividades', ['Fecha y Hora', 'Detalle'], causa.actividades, [formatDateTime, v => v]);
            
            // CORRECCIÓN: Mostrar observaciones generales
            contenidoHTML += `<div class="form-group"><label><strong>Observaciones Generales:</strong></label><p>${causa.observacionesGenerales || 'N/A'}</p></div>`;
            
            detalleContenido.innerHTML = contenidoHTML;
            modalVer.style.display = 'block';
        }

        // --- GESTIÓN DE DATOS ---

        async function guardarRegistro(event) {
            event.preventDefault();
            const numeroCaratula = document.getElementById('numeroCaratula').value;
            
            if (!numeroCaratula.trim()) {
                showToast('El campo "Número y Carátula" es obligatorio.', 'error');
                return;
            }
            
            // MEJORA UX: Deshabilitar botón para evitar doble envío
            btnGuardar.disabled = true;
            btnGuardar.textContent = 'Guardando...';

            const causa = {
                numeroCaratula,
                tipoProceso: document.getElementById('tipoProceso').value,
                juzgado: document.getElementById('juzgado').value,
                empleado: document.getElementById('empleado').value,
                documentosPresentados: document.getElementById('documentosPresentados').value,
                estadoDocumental: document.getElementById('estadoDocumental').value,
                modoIntervencion: document.getElementById('modoIntervencion').value,
                prioridadTarea: document.getElementById('prioridadTarea').value,
                estadoProcesal: document.getElementById('estadoProcesal').value,
                fechaEstado: document.getElementById('fechaEstado').value,
                // CORRECCIÓN: Usar el id correcto del textarea y el nombre de propiedad consistente
                observacionesGenerales: document.getElementById('observacionesGenerales').value,
                seguimiento: obtenerDatosTabla('#tablaSeguimiento tbody', ['fecha', 'detalles']),
                audiencias: obtenerDatosTabla('#tablaAudiencias tbody', ['fechaHora', 'detalle']),
                vencimientos: obtenerDatosTabla('#tablaVencimientos tbody', ['fechaHora', 'detalle']),
                actividades: obtenerDatosTabla('#tablaActividades tbody', ['fechaHora', 'detalle']),
                firmaDigital: obtenerDatosTabla('#tablaFirmaDigital tbody', ['piezaProcesal', 'fechaFirma', 'firmaDe', 'tipoDefensor', 'detalleSubrogante'])
            };
            
            const causaGuardada = await guardarCausaEnFirebase(causa);
            
            if (causaGuardada) {
                if (editingId) {
                    const index = causas.findIndex(c => c.id === editingId);
                    if (index !== -1) causas[index] = { ...causaGuardada, id: editingId };
                } else {
                    causas.push(causaGuardada);
                }
                
                localStorage.setItem('causas', JSON.stringify(causas));
                modalRegistro.style.display = 'none';
                // MEJORA: Vuelve a renderizar la tabla con el filtro actual aplicado
                filtrarYRenderizar();
            }
            
            btnGuardar.disabled = false;
            btnGuardar.textContent = 'Guardar';
        }

        async function confirmAndDelete(id, numeroCaratula) {
            if (confirm(`¿Está seguro de que desea eliminar la causa:\n"${numeroCaratula}"?`)) {
                if (await eliminarCausaDeFirebase(id)) {
                    causas = causas.filter(c => c.id !== id);
                    localStorage.setItem('causas', JSON.stringify(causas));
                    filtrarYRenderizar();
                }
            }
        }
        
        function filtrarYRenderizar() {
            const filtro = filtroBusqueda.value.toLowerCase();
            const filtered = causas.filter(causa => 
                Object.values(causa).some(val => 
                    String(val).toLowerCase().includes(filtro)
                )
            );
            renderTable(filtered);
        }

        // --- INICIALIZACIÓN ---

        function init() {
            cargarCausasDesdeFirebase();
            cargarDatosCausas(); // Cargar datos para autocompletar
            initTabs();
            
            // Configurar tablas dinámicas
            setupDynamicTable('tablaSeguimiento', 'btnAgregarSeguimiento', () => agregarFilaSeguimiento());
            setupDynamicTable('tablaAudiencias', 'btnAgregarAudiencia', () => agregarFilaFechaHora(tablaAudiencias));
            setupDynamicTable('tablaVencimientos', 'btnAgregarVencimiento', () => agregarFilaFechaHora(tablaVencimientos));
            setupDynamicTable('tablaActividades', 'btnAgregarActividad', () => agregarFilaFechaHora(tablaActividades));
            setupDynamicTable('tablaFirmaDigital', 'btnAgregarFirma', () => agregarFilaFirmaDigital());

            btnNuevoRegistro.addEventListener('click', () => abrirModalRegistro());
            btnImprimirListado.addEventListener('click', () => window.print());
            
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    modalRegistro.style.display = 'none';
                    modalVer.style.display = 'none';
                });
            });
            
            window.addEventListener('click', (e) => {
                if (e.target === modalRegistro) modalRegistro.style.display = 'none';
                if (e.target === modalVer) modalVer.style.display = 'none';
            });
            
            // CORRECCIÓN/MEJORA: La búsqueda ahora incluye todos los campos, incluyendo observaciones.
            filtroBusqueda.addEventListener('input', () => {
                currentPage = 1;
                filtrarYRenderizar();
            });
            
            formRegistro.addEventListener('submit', guardarRegistro);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
