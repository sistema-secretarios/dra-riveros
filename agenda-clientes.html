<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Clientes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary-color: #2e7d32;
            --primary-light: #4caf50;
            --primary-dark: #1b5e20;
            --accent-color: #8bc34a;
            --text-light: #f5f5f5;
            --text-dark: #333;
            --background: #f9f9f9;
            --card-bg: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --table-header: #e8f5e9;
            --table-row-even: #f9f9f9;
            --table-row-hover: #f1f8e9;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background);
            color: var(--text-dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 15px 0;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
            justify-content: space-between;
        }

        .search-container {
            position: relative;
            flex-grow: 1;
            max-width: 500px;
        }

        .search-container input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: none;
            border-radius: 50px;
            background-color: rgba(255, 255, 255, 0.2);
            color: var(--text-light);
            font-size: 1rem;
        }

        .search-container input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .search-container i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        .actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-light);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--text-light);
            border: 1px solid var(--text-light);
        }

        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .btn-danger {
            background-color: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        /* Estilos para la tabla */
        .table-container {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: var(--table-header);
        }

        th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--primary-dark);
            border-bottom: 2px solid var(--primary-light);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        tbody tr:nth-child(even) {
            background-color: var(--table-row-even);
        }

        tbody tr:hover {
            background-color: var(--table-row-hover);
        }

        .contact-name {
            font-weight: 600;
            color: var(--primary-dark);
        }

        .contact-dni {
            font-family: monospace;
        }

        .contact-phone {
            white-space: nowrap;
        }

        .contact-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-active {
            background-color: #e8f5e9;
            color: var(--primary-dark);
        }

        .status-closed {
            background-color: #ffebee;
            color: #c62828;
        }

        .status-process {
            background-color: #fff3e0;
            color: #ef6c00;
        }

        .status-pending {
            background-color: #e3f2fd;
            color: #1565c0;
        }

        .employment-status {
            font-size: 0.85rem;
        }

        .table-actions {
            display: flex;
            gap: 8px;
        }

        .table-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--primary-color);
            transition: color 0.3s ease;
            padding: 5px;
            border-radius: 4px;
        }

        .table-actions button:hover {
            color: var(--primary-dark);
            background-color: rgba(0, 0, 0, 0.05);
        }

        .delete-btn {
            color: #f44336 !important;
        }

        .delete-btn:hover {
            color: #d32f2f !important;
        }

        /* Paginaci√≥n */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background-color: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .pagination button:hover {
            background-color: var(--primary-light);
            color: white;
            border-color: var(--primary-light);
        }

        .pagination button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination button:disabled {
            background-color: #f5f5f5;
            color: #ccc;
            cursor: not-allowed;
        }

        .pagination-info {
            margin: 0 15px;
            font-size: 0.9rem;
            color: #666;
        }

        /* Alertas */
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: 600;
            z-index: 2000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(400px);
            transition: transform 0.5s ease;
            display: none;
        }

        .alert.show {
            transform: translateX(0);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background-color: var(--primary-dark);
        }

        .alert-danger {
            background-color: #d32f2f;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            width: 90%;
            max-width: 800px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .modal-header {
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.5rem;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab.active {
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .required::after {
            content: " *";
            color: red;
        }

        .modal-footer {
            padding: 15px 20px;
            background-color: #f5f5f5;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-top: 1px solid #ddd;
        }

        .btn-cancel {
            background-color: #f44336;
            color: white;
        }

        .btn-cancel:hover {
            background-color: #d32f2f;
        }

        .btn-save {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-save:hover {
            background-color: var(--primary-dark);
        }

        /* Modal de Visualizaci√≥n (Ver) */
        .view-modal-content {
            background-color: var(--card-bg);
            width: 90%;
            max-width: 600px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .view-modal-body {
            padding: 25px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .view-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .view-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .view-section-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .view-field {
            margin-bottom: 12px;
            color: #000;
        }

        .view-field:last-child {
            margin-bottom: 0;
        }

        .view-field-label {
            font-weight: 500;
            display: block;
            margin-bottom: 4px;
            color: #555;
        }

        .view-field-value {
            color: #000;
            line-height: 1.5;
        }

        .empty-field {
            color: #888;
            font-style: italic;
        }

        /* Print Styles */
        @media print {
            header, .actions, .table-actions, .pagination {
                display: none !important;
            }
            
            .table-container {
                box-shadow: none;
                border: 1px solid #ddd;
            }
            
            body {
                background: white;
            }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .table-container {
                overflow-x: auto;
            }
            
            table {
                min-width: 1000px;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .header-controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .search-container {
                width: 100%;
                max-width: 100%;
            }
            
            .actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .modal-content, .view-modal-content {
                width: 95%;
            }
            
            .view-modal-body {
                padding: 15px;
            }
            
            .pagination {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 576px) {
            .header-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-container, .actions {
                width: 100%;
            }
            
            .actions {
                justify-content: space-between;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="header-controls">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Buscar en todos los campos...">
                    </div>
                    <div class="actions">
                        <button class="btn btn-primary" id="addContactBtn">
                            <i class="fas fa-plus"></i> Nuevo Contacto
                        </button>
                        <button class="btn btn-secondary" id="printBtn">
                            <i class="fas fa-print"></i> Imprimir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="table-container">
            <table id="contactsTable">
                <thead>
                    <tr>
                        <th>Apellido y Nombre</th>
                        <th>DNI</th>
                        <th>Tel√©fono</th>
                        <th>Email</th>
                        <th>Estado del Caso</th>
                        <th>Observaciones</th>
                        <th>√öltima Actualizaci√≥n</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="contactsTableBody">
                    <!-- Los contactos se cargar√°n aqu√≠ din√°micamente -->
                </tbody>
            </table>
        </div>

        <!-- Paginaci√≥n -->
        <div class="pagination" id="pagination">
            <!-- La paginaci√≥n se generar√° din√°micamente -->
        </div>
    </div>

    <!-- Alertas -->
    <div class="alert alert-success" id="successAlert">
        <i class="fas fa-check-circle"></i> Contacto guardado correctamente
    </div>

    <div class="alert alert-danger" id="deleteAlert">
        <i class="fas fa-exclamation-circle"></i> Contacto eliminado correctamente
    </div>

    <!-- Modal para agregar/editar contactos -->
    <div class="modal" id="contactModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nuevo Contacto</h2>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="basic">Informaci√≥n B√°sica</div>
                    <div class="tab" data-tab="contact">Contacto</div>
                    <div class="tab" data-tab="health">Salud</div>
                    <div class="tab" data-tab="work">Laboral</div>
                    <div class="tab" data-tab="legal">Antecedentes</div>
                    <div class="tab" data-tab="observations">Observaciones</div>
                </div>

                <form id="contactForm">
                    <div class="tab-content active" id="basic-tab">
                        <div class="form-group">
                            <label for="lastName" class="required">Apellido</label>
                            <input type="text" id="lastName" required>
                        </div>
                        <div class="form-group">
                            <label for="firstName" class="required">Nombre Completo</label>
                            <input type="text" id="firstName" required>
                        </div>
                        <div class="form-group">
                            <label for="dni">DNI</label>
                            <input type="text" id="dni">
                        </div>
                        <div class="form-group">
                            <label for="birthDate">Fecha de Nacimiento</label>
                            <input type="text" id="birthDate" placeholder="DD/MM/AAAA">
                        </div>
                    </div>

                    <div class="tab-content" id="contact-tab">
                        <div class="form-group">
                            <label for="phone">Tel√©fono</label>
                            <input type="text" id="phone">
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email">
                        </div>
                        <div class="form-group">
                            <label for="address">Direcci√≥n</label>
                            <textarea id="address"></textarea>
                        </div>
                    </div>

                    <div class="tab-content" id="health-tab">
                        <div class="form-group">
                            <label for="healthStatus">Estado de Salud Actual</label>
                            <textarea id="healthStatus"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="medications">Medicamentos</label>
                            <textarea id="medications"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="healthObservations">Observaciones de Salud</label>
                            <textarea id="healthObservations"></textarea>
                        </div>
                    </div>

                    <div class="tab-content" id="work-tab">
                        <div class="form-group">
                            <label for="employmentStatus">Situaci√≥n Laboral</label>
                            <select id="employmentStatus">
                                <option value="">Seleccionar...</option>
                                <option value="empleado">Empleado</option>
                                <option value="desempleado">Desempleado</option>
                                <option value="jubilado">Jubilado/Pensionado</option>
                                <option value="informal">Trabajo Informal</option>
                                <option value="independiente">Trabajador Independiente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="occupation">Ocupaci√≥n/Profesi√≥n</label>
                            <input type="text" id="occupation">
                        </div>
                        <div class="form-group">
                            <label for="workplace">Lugar de Trabajo</label>
                            <input type="text" id="workplace">
                        </div>
                        <div class="form-group">
                            <label for="income">Ingresos Aproximados</label>
                            <input type="text" id="income">
                        </div>
                    </div>

                    <div class="tab-content" id="legal-tab">
                        <div class="form-group">
                            <label for="criminalRecord">Antecedentes Judiciales Penales</label>
                            <textarea id="criminalRecord"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="civilRecord">Antecedentes Judiciales Civiles</label>
                            <textarea id="civilRecord"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="familyRecord">Antecedentes Judiciales Familia</label>
                            <textarea id="familyRecord"></textarea>
                        </div>
                    </div>

                    <div class="tab-content" id="observations-tab">
                        <div class="form-group">
                            <label for="generalObservations">Observaciones Generales</label>
                            <textarea id="generalObservations"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="caseStatus">Estado del Caso</label>
                            <select id="caseStatus">
                                <option value="">Seleccionar...</option>
                                <option value="activo">Activo</option>
                                <option value="cerrado">Cerrado</option>
                                <option value="en_proceso">En Proceso</option>
                                <option value="pendiente">Pendiente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="lastUpdate">√öltima Actualizaci√≥n</label>
                            <input type="text" id="lastUpdate" readonly>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" id="cancelBtn">Cancelar</button>
                <button class="btn btn-save" id="saveBtn">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para visualizar contactos (Ver) -->
    <div class="modal" id="viewModal">
        <div class="view-modal-content">
            <div class="modal-header">
                <h2 id="viewModalTitle">Detalles del Contacto</h2>
                <button class="close-modal" id="closeViewModal">&times;</button>
            </div>
            <div class="view-modal-body" id="viewModalBody">
                <!-- El contenido se cargar√° din√°micamente -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" id="closeViewModalBtn">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDJZiGAhByx5zCIVg79fIMlzE1njuauW3k",
            authDomain: "secretarios-def.firebaseapp.com",
            projectId: "secretarios-def",
            storageBucket: "secretarios-def.firebasestorage.app",
            messagingSenderId: "533584198983",
            appId: "1:533584198983:web:f51f57146ed16c813ca062"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Datos iniciales vac√≠os para que el usuario agregue manualmente
        let contacts = [];

        // Variables de paginaci√≥n
        let currentPage = 1;
        const contactsPerPage = 10;

        // Elementos DOM
        const contactsTableBody = document.getElementById('contactsTableBody');
        const paginationContainer = document.getElementById('pagination');
        const contactModal = document.getElementById('contactModal');
        const viewModal = document.getElementById('viewModal');
        const contactForm = document.getElementById('contactForm');
        const searchInput = document.getElementById('searchInput');
        const addContactBtn = document.getElementById('addContactBtn');
        const closeModal = document.getElementById('closeModal');
        const closeViewModal = document.getElementById('closeViewModal');
        const closeViewModalBtn = document.getElementById('closeViewModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveBtn = document.getElementById('saveBtn');
        const printBtn = document.getElementById('printBtn');
        const modalTitle = document.getElementById('modalTitle');
        const viewModalTitle = document.getElementById('viewModalTitle');
        const viewModalBody = document.getElementById('viewModalBody');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const lastUpdateField = document.getElementById('lastUpdate');
        const successAlert = document.getElementById('successAlert');
        const deleteAlert = document.getElementById('deleteAlert');

        // Variables de estado
        let currentContactId = null;
        let isEditing = false;
        let filteredContacts = [];

        // Inicializar la aplicaci√≥n
        async function init() {
            await loadContactsFromFirestore();
            renderContacts();
            setupEventListeners();
            setCurrentDateTime();
        }

        // Cargar contactos desde Firestore
        async function loadContactsFromFirestore() {
            try {
                const snapshot = await db.collection('clientes').get();
                contacts = [];
                snapshot.forEach(doc => {
                    const contact = doc.data();
                    contact.id = doc.id; // Usar el ID de Firestore
                    contacts.push(contact);
                });
                console.log(`${contacts.length} contactos cargados desde Firestore`);
            } catch (error) {
                console.error('Error al cargar contactos desde Firestore:', error);
            }
        }

        // Guardar un contacto individual en Firestore
        async function saveContactToFirestore(contact) {
            try {
                const contactCopy = {...contact};
                const contactId = contactCopy.id;
                delete contactCopy.id; // Eliminar el ID temporal
                
                await db.collection('clientes').doc(contactId).set(contactCopy);
                console.log('Contacto guardado en Firestore:', contactId);
                return true;
            } catch (error) {
                console.error('Error al guardar contacto en Firestore:', error);
                return false;
            }
        }

        // Eliminar un contacto de Firestore
        async function deleteContactFromFirestore(contactId) {
            try {
                await db.collection('clientes').doc(contactId).delete();
                console.log('Contacto eliminado de Firestore:', contactId);
                return true;
            } catch (error) {
                console.error('Error al eliminar contacto de Firestore:', error);
                return false;
            }
        }

        // Configurar event listeners
        function setupEventListeners() {
            addContactBtn.addEventListener('click', openAddModal);
            closeModal.addEventListener('click', closeContactModal);
            closeViewModal.addEventListener('click', closeViewModalFunc);
            closeViewModalBtn.addEventListener('click', closeViewModalFunc);
            cancelBtn.addEventListener('click', closeContactModal);
            saveBtn.addEventListener('click', saveContact);
            searchInput.addEventListener('input', filterContacts);
            printBtn.addEventListener('click', printContacts);
            
            // Tabs del modal
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Cerrar modal al hacer clic fuera
            contactModal.addEventListener('click', (e) => {
                if (e.target === contactModal) {
                    closeContactModal();
                }
            });
            
            viewModal.addEventListener('click', (e) => {
                if (e.target === viewModal) {
                    closeViewModalFunc();
                }
            });
        }

        // Ordenar contactos alfab√©ticamente por apellido
        function sortContacts(contactsArray) {
            return contactsArray.sort((a, b) => {
                const nameA = `${a.lastName} ${a.firstName}`.toUpperCase();
                const nameB = `${b.lastName} ${b.firstName}`.toUpperCase();
                if (nameA < nameB) return -1;
                if (nameA > nameB) return 1;
                return 0;
            });
        }

        // Renderizar contactos en tabla con paginaci√≥n
        function renderContacts(contactsToRender = contacts) {
            // Ordenar contactos alfab√©ticamente
            const sortedContacts = sortContacts(contactsToRender);
            
            // Calcular √≠ndices para la paginaci√≥n
            const startIndex = (currentPage - 1) * contactsPerPage;
            const endIndex = startIndex + contactsPerPage;
            const paginatedContacts = sortedContacts.slice(startIndex, endIndex);
            
            contactsTableBody.innerHTML = '';
            
            if (paginatedContacts.length === 0) {
                contactsTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px;">
                            No se encontraron contactos.
                        </td>
                    </tr>
                `;
                renderPagination(sortedContacts.length);
                return;
            }
            
            paginatedContacts.forEach(contact => {
                const row = document.createElement('tr');
                
                // Acortar las observaciones para mostrarlas en la tabla
                const shortObservations = contact.generalObservations 
                    ? (contact.generalObservations.length > 50 
                        ? contact.generalObservations.substring(0, 50) + '...' 
                        : contact.generalObservations)
                    : 'No especificado';
                
                row.innerHTML = `
                    <td>
                        <div class="contact-name">${contact.lastName}, ${contact.firstName}</div>
                    </td>
                    <td class="contact-dni">${contact.dni || 'No especificado'}</td>
                    <td class="contact-phone">${contact.phone || 'No especificado'}</td>
                    <td>${contact.email || 'No especificado'}</td>
                    <td>
                        <span class="contact-status ${getStatusClass(contact.caseStatus)}">
                            ${getStatusText(contact.caseStatus)}
                        </span>
                    </td>
                    <td>
                        <div class="employment-status">${shortObservations}</div>
                    </td>
                    <td>${contact.lastUpdate || 'No especificado'}</td>
                    <td>
                        <div class="table-actions">
                            <button class="edit-btn" data-id="${contact.id}" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="print-btn" data-id="${contact.id}" title="Imprimir">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="view-btn" data-id="${contact.id}" title="Ver detalles">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="delete-btn" data-id="${contact.id}" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                contactsTableBody.appendChild(row);
            });
            
            // Agregar event listeners a los botones de la tabla
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const contactId = e.currentTarget.getAttribute('data-id');
                    openEditModal(contactId);
                });
            });
            
            document.querySelectorAll('.print-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const contactId = e.currentTarget.getAttribute('data-id');
                    printContact(contactId);
                });
            });
            
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const contactId = e.currentTarget.getAttribute('data-id');
                    viewContact(contactId);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const contactId = e.currentTarget.getAttribute('data-id');
                    deleteContact(contactId);
                });
            });
            
            renderPagination(sortedContacts.length);
        }

        // Renderizar paginaci√≥n
        function renderPagination(totalContacts) {
            const totalPages = Math.ceil(totalContacts / contactsPerPage);
            
            paginationContainer.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Bot√≥n anterior
            const prevButton = document.createElement('button');
            prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderContacts(filteredContacts.length > 0 ? filteredContacts : contacts);
                }
            });
            paginationContainer.appendChild(prevButton);
            
            // Informaci√≥n de p√°gina actual
            const infoSpan = document.createElement('span');
            infoSpan.className = 'pagination-info';
            infoSpan.textContent = `P√°gina ${currentPage} de ${totalPages}`;
            paginationContainer.appendChild(infoSpan);
            
            // Bot√≥n siguiente
            const nextButton = document.createElement('button');
            nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderContacts(filteredContacts.length > 0 ? filteredContacts : contacts);
                }
            });
            paginationContainer.appendChild(nextButton);
            
            // Selector de p√°ginas (solo si hay muchas p√°ginas)
            if (totalPages > 5) {
                const pageSelect = document.createElement('select');
                pageSelect.addEventListener('change', (e) => {
                    currentPage = parseInt(e.target.value);
                    renderContacts(filteredContacts.length > 0 ? filteredContacts : contacts);
                });
                
                for (let i = 1; i <= totalPages; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    if (i === currentPage) option.selected = true;
                    pageSelect.appendChild(option);
                }
                
                paginationContainer.appendChild(pageSelect);
            }
        }

        // Abrir modal para agregar contacto
        function openAddModal() {
            currentContactId = null;
            isEditing = false;
            modalTitle.textContent = 'Nuevo Contacto';
            contactForm.reset();
            setCurrentDateTime();
            contactModal.style.display = 'flex';
            switchTab('basic');
        }

        // Abrir modal para editar contacto
        function openEditModal(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            currentContactId = contactId;
            isEditing = true;
            modalTitle.textContent = 'Editar Contacto';
            
            // Llenar el formulario con los datos del contacto
            document.getElementById('lastName').value = contact.lastName || '';
            document.getElementById('firstName').value = contact.firstName || '';
            document.getElementById('dni').value = contact.dni || '';
            document.getElementById('birthDate').value = contact.birthDate || '';
            document.getElementById('phone').value = contact.phone || '';
            document.getElementById('email').value = contact.email || '';
            document.getElementById('address').value = contact.address || '';
            document.getElementById('healthStatus').value = contact.healthStatus || '';
            document.getElementById('medications').value = contact.medications || '';
            document.getElementById('healthObservations').value = contact.healthObservations || '';
            document.getElementById('employmentStatus').value = contact.employmentStatus || '';
            document.getElementById('occupation').value = contact.occupation || '';
            document.getElementById('workplace').value = contact.workplace || '';
            document.getElementById('income').value = contact.income || '';
            document.getElementById('criminalRecord').value = contact.criminalRecord || '';
            document.getElementById('civilRecord').value = contact.civilRecord || '';
            document.getElementById('familyRecord').value = contact.familyRecord || '';
            document.getElementById('generalObservations').value = contact.generalObservations || '';
            document.getElementById('caseStatus').value = contact.caseStatus || '';
            document.getElementById('lastUpdate').value = contact.lastUpdate || '';
            
            contactModal.style.display = 'flex';
            switchTab('basic');
        }

        // Ver contacto en modal de visualizaci√≥n
        function viewContact(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            viewModalTitle.textContent = `${contact.lastName}, ${contact.firstName}`;
            
            // Construir el contenido del modal de visualizaci√≥n
            let content = '';
            
            // Informaci√≥n B√°sica
            content += `
                <div class="view-section">
                    <div class="view-section-title">Informaci√≥n B√°sica</div>
                    <div class="view-field">
                        <div class="view-field-label">Apellido y Nombre</div>
                        <div class="view-field-value">${contact.lastName}, ${contact.firstName}</div>
                    </div>
                    <div class="view-field">
                        <div class="view-field-label">DNI</div>
                        <div class="view-field-value">${contact.dni || '<span class="empty-field">No especificado</span>'}</div>
                    </div>
                    <div class="view-field">
                        <div class="view-field-label">Fecha de Nacimiento</div>
                        <div class="view-field-value">${contact.birthDate || '<span class="empty-field">No especificado</span>'}</div>
                    </div>
                </div>
            `;
            
            // Informaci√≥n de Contacto
            content += `
                <div class="view-section">
                    <div class="view-section-title">Informaci√≥n de Contacto</div>
                    <div class="view-field">
                        <div class="view-field-label">Tel√©fono</div>
                        <div class="view-field-value">${contact.phone || '<span class="empty-field">No especificado</span>'}</div>
                    </div>
                    <div class="view-field">
                        <div class="view-field-label">Email</div>
                        <div class="view-field-value">${contact.email || '<span class="empty-field">No especificado</span>'}</div>
                    </div>
                    <div class="view-field">
                        <div class="view-field-label">Direcci√≥n</div>
                        <div class="view-field-value">${contact.address || '<span class="empty-field">No especificado</span>'}</div>
                    </div>
                </div>
            `;
            
            // Situaci√≥n Laboral
            content += `
                <div class="view-section">
                    <div class="view-section-title">Situaci√≥n Laboral</div>
                    <div class="view-field">
                        <div class="view-field-label">Situaci√≥n Laboral</div>
                        <div class="view-field-value">${getEmploymentText(contact.employmentStatus) || '<span class="empty-field">No especificado</span>'}</div>
                    </div>
                    <div class="view-field">
                        <div class="view-field-label">Ocupaci√≥n/Profesi√≥n</div>
                        <div class="view-field-value">${contact.occupation || '<span class="empty-field">No especificado</span>'}</div>
                    </div>
                    <div class="view-field">
                        <div class="view-field-label">Lugar de Trabajo</div>
                        <div class="view-field-value">${contact.workplace || '<span class="empty-field">No especificado</span>'}</div>
                    </div>
                    <div class="view-field">
                        <div class="view-field-label">Ingresos Aproximados</div>
                        <div class="view-field-value">${contact.income || '<span class="empty-field">No especificado</span>'}</div>
                    </div>
                </div>
            `;
            
            // Estado del Caso
            content += `
                <div class="view-section">
                    <div class="view-section-title">Estado del Caso</div>
                    <div class="view-field">
                        <div class="view-field-label">Estado</div>
                        <div class="view-field-value">
                            <span class="contact-status ${getStatusClass(contact.caseStatus)}">
                                ${getStatusText(contact.caseStatus) || '<span class="empty-field">No especificado</span>'}
                            </span>
                        </div>
                    </div>
                    <div class="view-field">
                        <div class="view-field-label">√öltima Actualizaci√≥n</div>
                        <div class="view-field-value">${contact.lastUpdate || '<span class="empty-field">No especificado</span>'}</div>
                    </div>
                </div>
            `;
            
            // Observaciones Generales
            if (contact.generalObservations) {
                content += `
                    <div class="view-section">
                        <div class="view-section-title">Observaciones Generales</div>
                        <div class="view-field">
                            <div class="view-field-value">${contact.generalObservations}</div>
                        </div>
                    </div>
                `;
            }
            
            viewModalBody.innerHTML = content;
            viewModal.style.display = 'flex';
        }

        // Guardar contacto (nuevo o edici√≥n)
        async function saveContact() {
            // Validar campos obligatorios
            const lastName = document.getElementById('lastName').value.trim();
            const firstName = document.getElementById('firstName').value.trim();
            
            if (!lastName || !firstName) {
                alert('Por favor, complete los campos obligatorios (Apellido y Nombre)');
                return;
            }
            
            // Recopilar datos del formulario
            const contactData = {
                lastName: lastName,
                firstName: firstName,
                dni: document.getElementById('dni').value.trim(),
                birthDate: document.getElementById('birthDate').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                email: document.getElementById('email').value.trim(),
                address: document.getElementById('address').value.trim(),
                healthStatus: document.getElementById('healthStatus').value.trim(),
                medications: document.getElementById('medications').value.trim(),
                healthObservations: document.getElementById('healthObservations').value.trim(),
                employmentStatus: document.getElementById('employmentStatus').value,
                occupation: document.getElementById('occupation').value.trim(),
                workplace: document.getElementById('workplace').value.trim(),
                income: document.getElementById('income').value.trim(),
                criminalRecord: document.getElementById('criminalRecord').value.trim(),
                civilRecord: document.getElementById('civilRecord').value.trim(),
                familyRecord: document.getElementById('familyRecord').value.trim(),
                generalObservations: document.getElementById('generalObservations').value.trim(),
                caseStatus: document.getElementById('caseStatus').value,
                lastUpdate: document.getElementById('lastUpdate').value
            };
            
            if (isEditing) {
                // Actualizar contacto existente
                const contactIndex = contacts.findIndex(c => c.id === currentContactId);
                if (contactIndex !== -1) {
                    contacts[contactIndex] = {
                        ...contacts[contactIndex],
                        ...contactData
                    };
                    // Guardar en Firestore
                    const success = await saveContactToFirestore(contacts[contactIndex]);
                    if (!success) {
                        alert('Error al guardar el contacto en la base de datos');
                        return;
                    }
                }
            } else {
                // Crear nuevo contacto
                const newContact = {
                    id: Date.now().toString(), // ID simple basado en timestamp
                    ...contactData
                };
                contacts.push(newContact);
                // Guardar en Firestore
                const success = await saveContactToFirestore(newContact);
                if (!success) {
                    alert('Error al guardar el contacto en la base de datos');
                    return;
                }
            }
            
            closeContactModal();
            renderContacts(filteredContacts.length > 0 ? filteredContacts : contacts);
            showAlert('success');
        }

        // Eliminar contacto
        async function deleteContact(contactId) {
            if (confirm('¬øEst√° seguro de que desea eliminar este contacto?')) {
                // Eliminar de Firestore
                const success = await deleteContactFromFirestore(contactId);
                if (!success) {
                    alert('Error al eliminar el contacto de la base de datos');
                    return;
                }
                
                contacts = contacts.filter(c => c.id !== contactId);
                filteredContacts = filteredContacts.filter(c => c.id !== contactId);
                
                // Ajustar la p√°gina actual si es necesario
                const totalFiltered = filteredContacts.length > 0 ? filteredContacts.length : contacts.length;
                const totalPages = Math.ceil(totalFiltered / contactsPerPage);
                
                if (currentPage > totalPages && totalPages > 0) {
                    currentPage = totalPages;
                }
                
                renderContacts(filteredContacts.length > 0 ? filteredContacts : contacts);
                showAlert('delete');
            }
        }

        // Filtrar contactos
        function filterContacts() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                filteredContacts = [];
                currentPage = 1;
                renderContacts(contacts);
                return;
            }
            
            filteredContacts = contacts.filter(contact => {
                return (
                    (contact.lastName && contact.lastName.toLowerCase().includes(searchTerm)) ||
                    (contact.firstName && contact.firstName.toLowerCase().includes(searchTerm)) ||
                    (contact.dni && contact.dni.toLowerCase().includes(searchTerm)) ||
                    (contact.phone && contact.phone.toLowerCase().includes(searchTerm)) ||
                    (contact.email && contact.email.toLowerCase().includes(searchTerm)) ||
                    (contact.occupation && contact.occupation.toLowerCase().includes(searchTerm)) ||
                    (contact.workplace && contact.workplace.toLowerCase().includes(searchTerm)) ||
                    (contact.employmentStatus && getEmploymentText(contact.employmentStatus).toLowerCase().includes(searchTerm)) ||
                    (contact.caseStatus && getStatusText(contact.caseStatus).toLowerCase().includes(searchTerm)) ||
                    (contact.generalObservations && contact.generalObservations.toLowerCase().includes(searchTerm))
                );
            });
            
            currentPage = 1;
            renderContacts(filteredContacts);
        }

        // Imprimir contactos
        function printContacts() {
            window.print();
        }

        // Imprimir un contacto espec√≠fico
        function printContact(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Ficha de ${contact.lastName}, ${contact.firstName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #2e7d32; border-bottom: 2px solid #2e7d32; padding-bottom: 10px; }
                        .section { margin-bottom: 20px; }
                        .section-title { font-weight: bold; color: #2e7d32; margin-bottom: 5px; }
                        .field { margin-bottom: 8px; }
                        .field-label { font-weight: bold; }
                        .empty-field { color: #888; font-style: italic; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <h1>${contact.lastName}, ${contact.firstName}</h1>
                    
                    <div class="section">
                        <div class="section-title">Informaci√≥n B√°sica</div>
                        <div class="field">
                            <span class="field-label">Apellido y Nombre:</span> ${contact.lastName}, ${contact.firstName}
                        </div>
                        <div class="field">
                            <span class="field-label">DNI:</span> ${contact.dni || '<span class="empty-field">No especificado</span>'}
                        </div>
                        <div class="field">
                            <span class="field-label">Fecha de Nacimiento:</span> ${contact.birthDate || '<span class="empty-field">No especificado</span>'}
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">Informaci√≥n de Contacto</div>
                        <div class="field">
                            <span class="field-label">Tel√©fono:</span> ${contact.phone || '<span class="empty-field">No especificado</span>'}
                        </div>
                        <div class="field">
                            <span class="field-label">Email:</span> ${contact.email || '<span class="empty-field">No especificado</span>'}
                        </div>
                        <div class="field">
                            <span class="field-label">Direcci√≥n:</span> ${contact.address || '<span class="empty-field">No especificado</span>'}
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">Situaci√≥n Laboral</div>
                        <div class="field">
                            <span class="field-label">Situaci√≥n Laboral:</span> ${getEmploymentText(contact.employmentStatus) || '<span class="empty-field">No especificado</span>'}
                        </div>
                        <div class="field">
                            <span class="field-label">Ocupaci√≥n/Profesi√≥n:</span> ${contact.occupation || '<span class="empty-field">No especificado</span>'}
                        </div>
                        <div class="field">
                            <span class="field-label">Lugar de Trabajo:</span> ${contact.workplace || '<span class="empty-field">No especificado</span>'}
                        </div>
                        <div class="field">
                            <span class="field-label">Ingresos Aproximados:</span> ${contact.income || '<span class="empty-field">No especificado</span>'}
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">Estado del Caso</div>
                        <div class="field">
                            <span class="field-label">Estado:</span> ${getStatusText(contact.caseStatus) || '<span class="empty-field">No especificado</span>'}
                        </div>
                        <div class="field">
                            <span class="field-label">√öltima Actualizaci√≥n:</span> ${contact.lastUpdate || '<span class="empty-field">No especificado</span>'}
                        </div>
                    </div>
                    
                    ${contact.generalObservations ? `
                    <div class="section">
                        <div class="section-title">Observaciones Generales</div>
                        <div class="field">${contact.generalObservations}</div>
                    </div>
                    ` : ''}
                    
                    <div class="section">
                        <div class="field" style="margin-top: 30px; font-size: 12px; color: #666;">
                            Impreso el ${new Date().toLocaleDateString()} a las ${new Date().toLocaleTimeString()}
                        </div>
                    </div>
                    
                    <script>
                        window.onload = function() {
                            window.print();
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // Cerrar modal de contacto
        function closeContactModal() {
            contactModal.style.display = 'none';
        }

        // Cerrar modal de visualizaci√≥n
        function closeViewModalFunc() {
            viewModal.style.display = 'none';
        }

        // Cambiar pesta√±a en el modal
        function switchTab(tabId) {
            // Desactivar todas las pesta√±as
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Ocultar todos los contenidos
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Activar pesta√±a seleccionada
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            
            // Mostrar contenido correspondiente
            document.getElementById(`${tabId}-tab`).classList.add('active');
        }

        // Establecer fecha y hora actual en el campo de √∫ltima actualizaci√≥n
        function setCurrentDateTime() {
            const now = new Date();
            const formattedDate = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            lastUpdateField.value = formattedDate;
        }

        // Mostrar alerta
        function showAlert(type) {
            const alert = type === 'success' ? successAlert : deleteAlert;
            alert.classList.add('show');
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }

        // Obtener texto para estado laboral
        function getEmploymentText(status) {
            const statusMap = {
                'empleado': 'Empleado',
                'desempleado': 'Desempleado',
                'jubilado': 'Jubilado/Pensionado',
                'informal': 'Trabajo Informal',
                'independiente': 'Trabajador Independiente'
            };
            
            return statusMap[status] || status;
        }

        // Obtener texto para estado del caso
        function getStatusText(status) {
            const statusMap = {
                'activo': 'Activo',
                'cerrado': 'Cerrado',
                'en_proceso': 'En Proceso',
                'pendiente': 'Pendiente'
            };
            
            return statusMap[status] || status;
        }

        // Obtener clase CSS para estado del caso
        function getStatusClass(status) {
            const classMap = {
                'activo': 'status-active',
                'cerrado': 'status-closed',
                'en_proceso': 'status-process',
                'pendiente': 'status-pending'
            };
            
            return classMap[status] || 'status-pending';
        }

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>